ğŸ“ Error-Handling-Attacks-Juice-Shop/5-API-Error-Leakage/Read-Me.md

markdown
Copy
Edit
# ğŸ”¥ 5 â€“ API Error Leakage

> ğŸ“‚ Path: `Error-Handling-Attacks-Juice-Shop/5-API-Error-Leakage/`

---

## âš”ï¸ Description

This vulnerability occurs when a web application's **RESTful API** exposes internal data through **improper error responses**. When API endpoints fail due to malformed JSON, missing fields, invalid methods, or data type mismatches, developers often leave verbose error handlers enabled, exposing:

- **Stack traces**
- **Field-level schema validation errors**
- **Object structure expectations**
- **Sensitive response headers**
- **Unhandled exceptions revealing backend internals**

These API-layer misconfigurations violate best practices outlined in **OWASP API Top 10 (2023)**, particularly:

- **API2: Broken Authentication**
- **API6: Unrestricted Exposure of Error Messages**
- **API10: Unsafe Consumption of APIs**

---

## ğŸ§  Deep Technical PoC

### ğŸ¯ Objective

Interact with known REST endpoints of Juice Shop using malformed JSON, missing required fields, incorrect HTTP methods, or unexpected parameters. Trigger API failures and capture how the backend leaks internal validation structures or application logic.

---

### ğŸ› ï¸ Tools Used

| Tool              | Purpose                                                   |
|-------------------|-----------------------------------------------------------|
| ğŸ§° **Burp Suite**       | Intercept, replay, and modify API requests                |
| ğŸ§ª **curl / Postman**   | Send invalid JSON payloads and inspect response behavior   |
| ğŸ§± **DevTools (F12)**   | View API requests/responses generated by frontend          |
| ğŸ§¬ **JSON Fuzzers**     | Optional for automated schema disruption and injection     |

---

### ğŸ§ª Step-by-Step Exploitation Walkthrough

#### 1ï¸âƒ£ Start the Juice Shop

```bash
docker run --rm -p 3000:3000 bkimminich/juice-shop
Access:

arduino
Copy
Edit
http://localhost:3000
2ï¸âƒ£ Target Vulnerable API Endpoint
Focus on:

POST /rest/user/login

POST /rest/feedback

POST /rest/products/search

PUT /api/BasketItems/:id

3ï¸âƒ£ Send Malformed JSON
ğŸ”¸ Example A â€“ Missing Field (password)
bash
Copy
Edit
curl -X POST http://localhost:3000/rest/user/login \
-H "Content-Type: application/json" \
-d '{"email": "admin@juice-sh.op"}'
Expected:

json
Copy
Edit
{
  "error": "Cannot read property 'match' of undefined",
  "stack": "TypeError: Cannot read property ..."
}
ğŸ”¸ Example B â€“ Invalid Data Type
bash
Copy
Edit
curl -X POST http://localhost:3000/rest/feedback \
-H "Content-Type: application/json" \
-d '{"comment": {"nested": "bad"}, "rating": "excellent"}'
Expected:

Stack trace

Error about type coercion

Possible crash or internal exception handler triggered

ğŸ”¸ Example C â€“ Incorrect HTTP Method
bash
Copy
Edit
curl -X PUT http://localhost:3000/rest/user/login -v
Expected:

json
Copy
Edit
{
  "statusCode": 405,
  "error": "Method Not Allowed"
}
4ï¸âƒ£ Observe Headers and Trace Elements
Key elements to look for:

X-Powered-By: Express

Content-Type: application/json

stack, message, name fields in response

File paths, route/controller names

ORM or schema error messages (Sequelize, MongoError, ValidationError, etc.)

ğŸš© Hacker Insight
ğŸ“ Whatâ€™s Leaked?
Leak Element	Offensive Value
stack in JSON	Internal path, function names, route file
Missing field error	Input schema inference
Type coercion trace	Validation bypass opportunity
Headers (X-Powered-By)	Framework fingerprinting

ğŸ§¬ Recon Advantages
Allows reverse engineering of input schema

Enables inference of internal API behavior

Prepares ground for API fuzzing or injection

Informs payload crafting for other attacks (e.g., SSRF, IDOR)

ğŸ§¨ Real-World CVEs & Incidents
CVE-2022-31030 â€“ Improper error message exposure in API framework

Facebook GraphQL â€“ Verbose GraphQL errors exposing resolver internals

GitHub 2021 API Issue â€“ Leaked internal object references via error body

ğŸ’£ Exploit Demo Video
Add demo link showing:

Curl/Burp request to /rest/feedback with missing fields

Stack trace and schema errors exposed in API JSON response

ğŸ›¡ï¸ Mitigation Recommendations
Mitigation Step	Description
âœ… Centralized API error handling	Return generic error codes and redact trace
ğŸ§± Input schema validation	Enforce type-checking and mandatory fields
ğŸš« Strip X-Powered-By headers	Avoid framework disclosure
ğŸ” Limit detailed error logs to logs only	Avoid exposing raw errors to clients

Example Express middleware:

js
Copy
Edit
app.use((err, req, res, next) => {
  logger.error(err.stack);
  res.status(500).json({ message: "Unexpected server error." });
});
ğŸ§­ Mapping to Offensive Security Domains
Domain	Purpose Gained
Web App Pentesting	API structure leakage and injection
Red Teaming	Fuzz surface discovery and pivoting
API Security Review	Detect schema exposure and misconfig
AppSec Automation	Enable error enumeration for tooling

ğŸ“‚ Suggested Repo Artifacts
api_fuzz_payloads.json â€“ All invalid JSONs used

error_logs.json â€“ Raw responses showing schema leakage

headers_analysis.md â€“ Response header dissection

screenshots/ â€“ Stack trace exposure screenshots

api_crash_recon.md â€“ Full analysis of misbehaving API calls

ğŸ‘¨â€ğŸ’» Author
Shajohn16
OffSec Researcher | API Security Analyst | Stack Trace Hunter
GitHub: @Shajohn16
